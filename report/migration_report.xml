<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Migration Report Action -->
        <record id="action_migration_report" model="ir.actions.report">
            <field name="name">Migration Report</field>
            <field name="model">cs.cart.migration.log</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">cs_cart_migration_19.migration_report_template</field>
            <field name="print_report_name">'Migration Report - ' + (object.name or '')</field>
            <field name="binding_model_id" ref="model_cs_cart_migration_log"/>
            <field name="binding_type">report</field>
        </record>

        <!-- Report Template -->
        <template id="migration_report_template">
            <t t-call="web.html_container">
                <t t-call="web.internal_layout">
                    <div class="page">
                        <!-- Header -->
                        <div class="header text-center">
                            <h2>CS-Cart Migration Report</h2>
                            <p>Migration Date: <span t-esc="format_date(time)"/></p>
                            <hr/>
                        </div>

                        <!-- Report Content -->
                        <div class="content">
                            <!-- Summary Section -->
                            <div class="row">
                                <div class="col-12">
                                    <h4>Migration Summary</h4>
                                    <table class="table table-bordered">
                                        <tr>
                                            <th>Connection</th>
                                            <td t-field="docs[0].connection_id.name"/>
                                        </tr>
                                        <tr>
                                            <th>Migration Type</th>
                                            <td t-field="docs[0].migration_type"/>
                                        </tr>
                                        <tr>
                                            <th>Status</th>
                                            <td>
                                                <span t-esc="docs[0].status" 
                                                      t-attf-class="badge 
                                                        {{ 'badge-success' if docs[0].status == 'completed' else 
                                                           'badge-warning' if docs[0].status == 'partial' else 
                                                           'badge-danger' if docs[0].status == 'failed' else 
                                                           'badge-info' }}"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Start Date</th>
                                            <td t-field="docs[0].start_date"/>
                                        </tr>
                                        <tr>
                                            <th>End Date</th>
                                            <td t-field="docs[0].end_date"/>
                                        </tr>
                                        <tr>
                                            <th>Duration</th>
                                            <td t-field="docs[0].duration"/> seconds
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <!-- Statistics Section -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h4>Migration Statistics</h4>
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Metric</th>
                                                <th>Value</th>
                                                <th>Percentage</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Total Records</td>
                                                <td t-esc="docs[0].total_records"/>
                                                <td>100%</td>
                                            </tr>
                                            <tr>
                                                <td>Processed Records</td>
                                                <td t-esc="docs[0].processed_records"/>
                                                <td t-esc="'%.2f' % ((docs[0].processed_records/docs[0].total_records*100) if docs[0].total_records > 0 else 0)"/>%
                                            </tr>
                                            <tr>
                                                <td>Successful Records</td>
                                                <td t-esc="docs[0].successful_records"/>
                                                <td t-esc="'%.2f' % ((docs[0].successful_records/docs[0].total_records*100) if docs[0].total_records > 0 else 0)"/>%
                                            </tr>
                                            <tr>
                                                <td>Failed Records</td>
                                                <td t-esc="docs[0].failed_records"/>
                                                <td t-esc="'%.2f' % ((docs[0].failed_records/docs[0].total_records*100) if docs[0].total_records > 0 else 0)"/>%
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Error Details Section -->
                            <div t-if="docs[0].error_message" class="row mt-4">
                                <div class="col-12">
                                    <h4>Error Details</h4>
                                    <div class="alert alert-danger">
                                        <pre t-esc="docs[0].error_message"/>
                                    </div>
                                </div>
                            </div>

                            <!-- Migration Details Section -->
                            <div t-if="docs[0].details" class="row mt-4">
                                <div class="col-12">
                                    <h4>Migration Details</h4>
                                    <div class="alert alert-info">
                                        <pre t-esc="docs[0].details"/>
                                    </div>
                                </div>
                            </div>

                            <!-- Multiple Logs Summary (if multiple logs) -->
                            <div t-if="len(docs) > 1" class="row mt-4">
                                <div class="col-12">
                                    <h4>Multiple Migrations Summary</h4>
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Type</th>
                                                <th>Status</th>
                                                <th>Total</th>
                                                <th>Successful</th>
                                                <th>Failed</th>
                                                <th>Duration</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr t-foreach="docs" t-as="log">
                                                <td t-esc="log.create_date.strftime('%Y-%m-%d %H:%M')"/>
                                                <td t-esc="log.migration_type"/>
                                                <td>
                                                    <span t-esc="log.status" 
                                                          t-attf-class="badge 
                                                            {{ 'badge-success' if log.status == 'completed' else 
                                                               'badge-warning' if log.status == 'partial' else 
                                                               'badge-danger' if log.status == 'failed' else 
                                                               'badge-info' }}"/>
                                                </td>
                                                <td t-esc="log.total_records"/>
                                                <td t-esc="log.successful_records"/>
                                                <td t-esc="log.failed_records"/>
                                                <td t-esc="log.duration"/>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th colspan="3">TOTAL</th>
                                                <th t-esc="sum([log.total_records for log in docs])"/>
                                                <th t-esc="sum([log.successful_records for log in docs])"/>
                                                <th t-esc="sum([log.failed_records for log in docs])"/>
                                                <th t-esc="sum([log.duration for log in docs])"/>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            <!-- Success Rate Chart (visual representation) -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h4>Success Rate</h4>
                                    <div class="progress" style="height: 30px;">
                                        <div class="progress-bar bg-success" 
                                             t-att-style="'width: ' + 
                                                         ((docs[0].successful_records/docs[0].total_records*100) 
                                                          if docs[0].total_records > 0 else 0) + '%;'">
                                            Successful: <span t-esc="docs[0].successful_records"/>
                                        </div>
                                        <div class="progress-bar bg-danger" 
                                             t-att-style="'width: ' + 
                                                         ((docs[0].failed_records/docs[0].total_records*100) 
                                                          if docs[0].total_records > 0 else 0) + '%;'">
                                            Failed: <span t-esc="docs[0].failed_records"/>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Footer Notes -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="alert alert-light">
                                        <h6>Report Notes:</h6>
                                        <ul>
                                            <li>This report was generated automatically by the CS-Cart Migration Module</li>
                                            <li>Duration is measured in seconds</li>
                                            <li>Status definitions:
                                                <ul>
                                                    <li><strong>Completed</strong>: All records processed successfully</li>
                                                    <li><strong>Partial</strong>: Some records failed but migration continued</li>
                                                    <li><strong>Failed</strong>: Migration stopped due to critical error</li>
                                                    <li><strong>In Progress</strong>: Migration is still running</li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="footer text-center mt-4">
                            <hr/>
                            <p>Generated by Odoo CS-Cart Migration Module</p>
                            <p>Page <span class="page"/> of <span class="topage"/></p>
                        </div>
                    </div>
                </t>
            </t>
        </template>

        <!-- Report Menu Item -->
        <record id="action_migration_report_menu" model="ir.actions.act_window">
            <field name="name">Migration Reports</field>
            <field name="res_model">cs.cart.migration.log</field>
            <field name="view_mode">tree,form</field>
        </record>

        <!-- Print Report Button in Log Form -->
        <record id="view_cs_cart_migration_log_form_extended" model="ir.ui.view">
            <field name="name">cs.cart.migration.log.form.extended</field>
            <field name="model">cs.cart.migration.log</field>
            <field name="inherit_id" ref="cs_cart_migration_19.view_cs_cart_migration_log_form"/>
            <field name="arch" type="xml">
                <xpath expr="//header" position="inside">
                    <button name="print_report" type="object"
                            class="btn-primary"
                            string="Print Report"
                            args="[ref('cs_cart_migration_19.action_migration_report')]"/>
                </xpath>
            </field>
        </record>

        <!-- Report Button in Log Tree -->
        <record id="view_cs_cart_migration_log_tree_extended" model="ir.ui.view">
            <field name="name">cs.cart.migration.log.tree.extended</field>
            <field name="model">cs.cart.migration.log</field>
            <field name="inherit_id" ref="cs_cart_migration_19.view_cs_cart_migration_log_tree"/>
            <field name="arch" type="xml">
                <xpath expr="//tree" position="inside">
                    <button name="print_report" type="object"
                            class="btn-secondary btn-sm"
                            string="Print"
                            args="[ref('cs_cart_migration_19.action_migration_report')]"
                            icon="fa-print"/>
                </xpath>
            </field>
        </record>

        <!-- Multiple Reports Template (for batch printing) -->
        <template id="multiple_migration_report_template">
            <t t-call="web.html_container">
                <t t-call="web.internal_layout">
                    <div class="page">
                        <div class="header text-center">
                            <h2>CS-Cart Migration Reports Summary</h2>
                            <p>Generated on: <span t-esc="format_date(time)"/></p>
                            <hr/>
                        </div>

                        <div class="content">
                            <!-- Overall Summary -->
                            <div class="row">
                                <div class="col-12">
                                    <h4>Overall Summary</h4>
                                    <table class="table table-bordered">
                                        <tr>
                                            <th>Total Migrations</th>
                                            <td t-esc="len(docs)"/></td>
                                        </tr>
                                        <tr>
                                            <th>Total Records Processed</th>
                                            <td t-esc="sum([log.total_records for log in docs])"/></td>
                                        </tr>
                                        <tr>
                                            <th>Total Successful Records</th>
                                            <td t-esc="sum([log.successful_records for log in docs])"/></td>
                                        </tr>
                                        <tr>
                                            <th>Total Failed Records</th>
                                            <td t-esc="sum([log.failed_records for log in docs])"/></td>
                                        </tr>
                                        <tr>
                                            <th>Overall Success Rate</th>
                                            <td t-esc="'%.2f%%' % ((sum([log.successful_records for log in docs]) / sum([log.total_records for log in docs]) * 100) if sum([log.total_records for log in docs]) > 0 else 0)"/></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <!-- Detailed Logs Table -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h4>Migration Logs Details</h4>
                                    <table class="table table-bordered table-striped">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Date</th>
                                                <th>Type</th>
                                                <th>Connection</th>
                                                <th>Status</th>
                                                <th>Total</th>
                                                <th>Successful</th>
                                                <th>Failed</th>
                                                <th>Duration</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="docs" t-as="log">
                                                <tr>
                                                    <td t-esc="log.id"/>
                                                    <td t-esc="log.create_date.strftime('%Y-%m-%d %H:%M')"/>
                                                    <td t-esc="log.migration_type"/>
                                                    <td t-esc="log.connection_id.name"/>
                                                    <td>
                                                        <span t-esc="log.status" 
                                                              t-attf-class="badge 
                                                                {{ 'badge-success' if log.status == 'completed' else 
                                                                   'badge-warning' if log.status == 'partial' else 
                                                                   'badge-danger' if log.status == 'failed' else 
                                                                   'badge-info' }}"/>
                                                    </td>
                                                    <td t-esc="log.total_records"/>
                                                    <td t-esc="log.successful_records"/>
                                                    <td t-esc="log.failed_records"/>
                                                    <td t-esc="log.duration"/>s
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Status Distribution Chart -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h4>Status Distribution</h4>
                                    <table class="table table-bordered">
                                        <tr>
                                            <th>Status</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                        </tr>
                                        <tr>
                                            <td><span class="badge badge-success">Completed</span></td>
                                            <td t-esc="len([log for log in docs if log.status == 'completed'])"/>
                                            <td t-esc="'%.1f%%' % (len([log for log in docs if log.status == 'completed']) / len(docs) * 100 if docs else 0)"/>
                                        </tr>
                                        <tr>
                                            <td><span class="badge badge-warning">Partial</span></td>
                                            <td t-esc="len([log for log in docs if log.status == 'partial'])"/>
                                            <td t-esc="'%.1f%%' % (len([log for log in docs if log.status == 'partial']) / len(docs) * 100 if docs else 0)"/>
                                        </tr>
                                        <tr>
                                            <td><span class="badge badge-danger">Failed</span></td>
                                            <td t-esc="len([log for log in docs if log.status == 'failed'])"/>
                                            <td t-esc="'%.1f%%' % (len([log for log in docs if log.status == 'failed']) / len(docs) * 100 if docs else 0)"/>
                                        </tr>
                                        <tr>
                                            <td><span class="badge badge-info">Other</span></td>
                                            <td t-esc="len([log for log in docs if log.status not in ['completed', 'partial', 'failed']])"/>
                                            <td t-esc="'%.1f%%' % (len([log for log in docs if log.status not in ['completed', 'partial', 'failed']]) / len(docs) * 100 if docs else 0)"/>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <!-- Recommendations -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <h6>Recommendations:</h6>
                                        <ul>
                                            <t t-if="len([log for log in docs if log.status == 'failed']) > len(docs) * 0.3">
                                                <li><strong>High failure rate detected:</strong> Consider checking CS-Cart database connectivity and structure</li>
                                            </t>
                                            <t t-if="sum([log.duration for log in docs]) / len(docs) if docs else 0 > 300">
                                                <li><strong>Slow migrations detected:</strong> Consider increasing batch size or optimizing queries</li>
                                            </t>
                                            <t t-if="sum([log.failed_records for log in docs]) > 0">
                                                <li><strong>Failed records found:</strong> Review error logs for specific issues</li>
                                            </t>
                                            <t t-if="len([log for log in docs if log.status == 'completed']) == len(docs)">
                                                <li><strong>Excellent performance:</strong> All migrations completed successfully</li>
                                            </t>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="footer text-center mt-4">
                            <hr/>
                            <p>CS-Cart Migration Module - Comprehensive Report</p>
                            <p>Page <span class="page"/> of <span class="topage"/></p>
                        </div>
                    </div>
                </t>
            </t>
        </template>

        <!-- Multiple Reports Action -->
        <record id="action_multiple_migration_report" model="ir.actions.report">
            <field name="name">Multiple Migration Reports</field>
            <field name="model">cs.cart.migration.log</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">cs_cart_migration_19.multiple_migration_report_template</field>
            <field name="print_report_name">'Multiple Migration Reports - ' + format_date(time)</field>
            <field name="multi">True</field>
        </record>
    </data>
</odoo>